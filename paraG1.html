<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ocean Game - Visible Edition</title>
<style>
  body { margin:0; overflow:hidden; background:#6ec6ff; }
</style>
</head>
<body>
<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158/examples/jsm/loaders/GLTFLoader.js";

const loader = new GLTFLoader();

loader.load("はらちゃん.glb", (gltf) => {
  scene.add(gltf.scene);
});

/* ---------------- シーン ---------------- */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x6ec6ff, 150, 600);

const camera = new THREE.PerspectiveCamera(65, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 5, 12);

const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.setClearColor(0x6ec6ff);
document.body.appendChild(renderer.domElement);

/* ========= 光（白飛びしない） ========= */
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const sun = new THREE.DirectionalLight(0xffffff, 0.9);
sun.position.set(30, 50, 30);
scene.add(sun);

/* ========= 海底 ========= */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(1000,1000),
  new THREE.MeshStandardMaterial({ color:0xeeddaa })
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ========= プレイヤー（必ず見える） ========= */
const player = new THREE.Mesh(
  new THREE.SphereGeometry(0.5, 16, 16),
  new THREE.MeshStandardMaterial({ color:0xffcc00 })
);
player.position.set(0,1,0);
scene.add(player);

/* ========= WASD ========= */
const keys = {};
addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

/* ========= 海藻（装飾・当たり判定なし） ========= */
const seaweeds=[];
for(let i=0;i<120;i++){
  const w = new THREE.Mesh(
    new THREE.CylinderGeometry(0.06,0.12,6,8),
    new THREE.MeshStandardMaterial({ color:0x33aa66 })
  );
  w.position.set(
    (Math.random()-0.5)*600,
    3,
    (Math.random()-0.5)*600
  );
  w.userData.o = Math.random()*Math.PI*2;
  seaweeds.push(w);
  scene.add(w);
}

/* ========= 岩 ========= */
for(let i=0;i<40;i++){
  const rock = new THREE.Mesh(
    new THREE.DodecahedronGeometry(1+Math.random()),
    new THREE.MeshStandardMaterial({ color:0x888888 })
  );
  rock.position.set(
    (Math.random()-0.5)*300,
    1,
    (Math.random()-0.5)*300
  );
  scene.add(rock);
}

/* ========= エネミー（GLBなければ仮） ========= */
const enemies=[];
function spawnEnemy(obj){
  obj.position.set(
    (Math.random()-0.5)*80,
    1,
    (Math.random()-0.5)*80
  );
  scene.add(obj);
  enemies.push(obj);
}

/* 仮エネミー（必ず出る） */
for(let i=0;i<5;i++){
  const dummy = new THREE.Mesh(
    new THREE.BoxGeometry(1,1,1),
    new THREE.MeshStandardMaterial({ color:0xff4444 })
  );
  spawnEnemy(dummy);
}

/* GLBあれば差し替え */
const loader = new GLTFLoader();
loader.load(
  "models/enemy.glb",
  g=>{
    enemies.forEach(e=>scene.remove(e));
    enemies.length=0;
    for(let i=0;i<5;i++){
      spawnEnemy(g.scene.clone());
    }
  },
  undefined,
  ()=>{ /* 読めなくても無視 */ }
);

/* ========= ループ ========= */
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const t=clock.getElapsedTime();

  const speed=0.12;
  if(keys["w"]) player.position.z-=speed;
  if(keys["s"]) player.position.z+=speed;
  if(keys["a"]) player.position.x-=speed;
  if(keys["d"]) player.position.x+=speed;

  camera.position.lerp(
    new THREE.Vector3(
      player.position.x,
      player.position.y+5,
      player.position.z+12
    ),0.08
  );
  camera.lookAt(player.position);

  seaweeds.forEach(w=>{
    w.rotation.z = Math.sin(t+w.userData.o)*0.3;
  });

  enemies.forEach(e=>{
    e.position.x += Math.sin(t*0.5)*0.01;
    e.position.z += Math.cos(t*0.5)*0.01;
  });

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
